@namespace RepositoryFramework.Web.Components.Standard
@typeparam T
@typeparam TKey where TKey: notnull
@inherits RepositoryBase<T, TKey>

<div class="mt-2">
    <div class="row">
        @if (Pagination.TotalItemCount.HasValue)
        {
            <div class="w-100 row">
                <div class="col-12">
                    <button @onclick="@((x) => _ = DownloadAsCsvAsync())" class="btn btn-outline-primary">
                        <span class="material-symbols-outlined material-symbols-outlined-small">
                            download
                        </span>
                    </button>
                    <CopyButton GetValue="@(() => CopyAsCsv())" Icon="content_copy" Class="btn btn-outline-secondary">
                    </CopyButton>
                    <div class="col-12 col-xxl-5 col-xl-6 col-lg-7 col-md-8 col-sm-9 float-md-end row">
                        <div class="col-1">
                            <button @onclick="@(() => GoToPage(0))" disabled=@(Pagination.CurrentPageIndex <= 0) class="btn btn-outline-dark">
                                <span class="material-symbols-outlined material-symbols-outlined-small">
                                    keyboard_double_arrow_left
                                </span>
                            </button>
                        </div>
                        <div class="col-1">
                            <button @onclick="@(() => GoToPage(Pagination.CurrentPageIndex - 1))" disabled=@(Pagination.CurrentPageIndex <= 0) class="btn btn-outline-dark">
                                <span class="material-symbols-outlined material-symbols-outlined-small">
                                    chevron_left
                                </span>
                            </button>
                        </div>
                        <div class="col-8 row">
                            <div class="col mt-2">Page</div>
                            <SelectDropdown PossibleValues="@GetPages()"
                                        OnChange="@(async (x) => GoToPage((int)x.Value))"
                                        SelectedKey="@_selectedPageKey"
                                        NotEditable=false
                                        Class="form-select col">
                            </SelectDropdown>
                            <div class="col text-nowrap mt-2">
                                of <strong>@(Pagination.LastPageIndex + 1)</strong>
                                (<strong>@Pagination.TotalItemCount</strong>) items.
                            </div>
                            <SelectDropdown PossibleValues="@GetPaging()"
                                        OnChange="@(async (x) => ChangeItemsPerPage((int)x.Value))"
                                        SelectedKey="@_selectedItemsForPageKey"
                                        NotEditable=false
                                        Class="form-select col">
                            </SelectDropdown>
                        </div>
                        <div class="col-1">
                            <button @onclick="@(() => GoToPage(Pagination.CurrentPageIndex + 1))" disabled=@(Pagination.CurrentPageIndex >= Pagination.LastPageIndex) class="btn btn-outline-dark">
                                <span class="material-symbols-outlined material-symbols-outlined-small">
                                    chevron_right
                                </span>
                            </button>
                        </div>
                        <div class="col-1">
                            <button @onclick="@(() => GoToPage(Pagination.LastPageIndex.Value))" disabled=@(Pagination.CurrentPageIndex >= Pagination.LastPageIndex) class="btn btn-outline-dark">
                                <span class="material-symbols-outlined material-symbols-outlined-small">
                                    keyboard_double_arrow_right
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="w-100 overflow-auto mt-2" style="min-height:400px;" tabindex="-1">
        <table class="table table-striped table-sticky">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    @foreach (var property in FlatProperties)
                    {
                        <th scope="col">
                            <div class="row">
                                @if (!property.NavigationPath.StartsWith(Constant.KeyWithSeparator) && property.NavigationPath != Constant.Key && property.Type != PropertyType.Enumerable)
                                {
                                    <div class="col">
                                        <button class="bg-transparent p-0 border-0 fw-bold w-100 text-start"
                                        @onclick="@((x) => OrderBy(property))">
                                            @property.GetFurtherProperty().Title
                                            <span class="material-symbols-outlined material-symbols-outlined-small float-end mt-1">
                                                @GetRightOrderingIcon(_columns[property.NavigationPath].Order)
                                            </span>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="col">@property.GetFurtherProperty().Title</div>
                                }
                            </div>
                        </th>
                    }
                </tr>
                <tr>
                    <th scope="col">
                        <RadzenDropDown TValue="IEnumerable<string>"
                                        AllowClear="true"
                                        AllowFiltering="true"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        Multiple="true"
                                        Placeholder="Select..."
                                        SelectedItemsText="columns selected."
                                        SelectAllText="All columns selected."
                                        Data="@_columns.Select(x => x.Value)"
                                        ValueProperty="@Constant.Value"
                                        TextProperty="@Constant.Label"
                                        Value="@_columns.Where(x => x.Value.IsActive).Select(x => x.Key)"
                                        Change="@UpdateColumnsVisibility" />
                        <input type="checkbox" checked="@_allSelected" class="form-check-input mt-2" @onchange="@(args => AddOrRemoveItemFromListAllKeys(args, _items.Select(x => x.Key)))" />
                    </th>
                    @foreach (var property in FlatProperties)
                    {
                        if (!property.NavigationPath.StartsWith(Constant.KeyWithSeparator) && property.NavigationPath != Constant.Key)
                        {
                            <th scope="col">
                                @if (property.Type != PropertyType.Enumerable)
                                {
                                    <QueryFilter SearchValue="_searchWrapper.Get(property)"
                                     PropertyUiSettings="GetPropertySettings(property)" Search="@Search" />
                                }
                            </th>
                        }
                        else
                        {
                            <th></th>
                        }
                    }
                </tr>
            </thead>
            <tbody>
                @if (_items != null)
                {
                    foreach (var item in _items)
                    {
                        <tr>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm"
                                @onclick="@((x) => NavigateTo(GetEditUri(item.Key!)))">
                                    <span class="material-symbols-outlined material-symbols-outlined-small">
                                        edit
                                    </span>
                                </button>
                                <input type="checkbox" class="form-check-input mt-2" checked="@_selectedKeys[item.Key]" value="@_selectedKeys[item.Key]" @onchange="@(args => AddOrRemoveItemFromList((bool)args.Value, item.Key))" />
                            </td>
                            @foreach (var property in FlatProperties)
                            {
                                <td>
                                    @if (property.Type != PropertyType.Enumerable)
                                    {
                                        <CopyButton GetValue="@(() => property.Value(item, null))" />
                                    }
                                    else
                                    {
                                        <RadzenButton class="bg-transparent text-dark p-0"
                                      Click="@((x) => ShowMoreValuesAsync(item, property))"
                                      Text="@EnumerableCountAsString(item, property)" />
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>